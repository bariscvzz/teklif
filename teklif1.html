<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ceviz Art • Fiyat Teklif Sistemi</title>

  <style>
    :root{
      --bg:#0b1220; --card:#0f1a2e; --muted:#a9b4c7; --text:#e9eef7;
      --line:rgba(255,255,255,.10); --shadow: 0 16px 40px rgba(0,0,0,.35);
      --radius:16px; --danger:#fb7185;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 600px at 20% 0%, rgba(96,165,250,.18), transparent 60%),
                  radial-gradient(900px 600px at 90% 10%, rgba(94,234,212,.14), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1280px;margin:0 auto;padding:24px}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:18px}
    h1{font-size:18px;margin:0}
    .sub{font-size:13px;color:var(--muted);margin-top:2px}
    .actions{display:flex;gap:10px;flex-wrap:wrap}
    button{
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      transition:.15s transform, .15s background;
      font-weight:800;
    }
    button:hover{transform: translateY(-1px); background: rgba(255,255,255,.09)}
    button.primary{
      background: linear-gradient(135deg, rgba(94,234,212,.22), rgba(96,165,250,.22));
      border-color: rgba(94,234,212,.35);
    }
    button.danger{border-color: rgba(251,113,133,.35); background: rgba(251,113,133,.10)}

    .grid{display:grid;grid-template-columns: 460px 1fr;gap:16px;align-items:start}
    @media (max-width: 1020px){ .grid{grid-template-columns:1fr} }

    .card{
      background: rgba(15,26,46,.86);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card h2{font-size:14px;margin:0;padding:14px 14px 0 14px;color:#dbe7ff}
    .content{padding:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .field{flex:1;min-width:160px}
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px 0}
    input, textarea, select{
      width:100%;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 10px;
      border-radius:12px;
      outline:none;
    }
    textarea{min-height:86px;resize:vertical}
    .divider{height:1px;background:var(--line);margin:12px 0}
    .hint{font-size:12px;color:var(--muted);line-height:1.35}

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      border:1px solid var(--line);
      border-radius: 14px;
      overflow:hidden;
    }
    thead th{
      font-size:12px;
      text-align:left;
      color:#dbe7ff;
      background: rgba(255,255,255,.06);
      padding:10px;
      border-bottom:1px solid var(--line);
      white-space:nowrap;
    }
    tbody td{padding:8px;border-bottom:1px solid rgba(255,255,255,.06);vertical-align:middle}
    tbody tr:last-child td{border-bottom:none}
    .mini{padding:8px 8px;border-radius:10px;font-size:13px}
    .num{text-align:right}
    .nowrap{white-space:nowrap}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      padding:8px 10px;border-radius:999px;
      font-size:12px;color:var(--muted);
    }

    .imgCell{display:flex;align-items:center;gap:8px;justify-content:flex-end}
    .thumb{
      width:38px;height:38px;border-radius:10px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      display:flex;align-items:center;justify-content:center;
      overflow:hidden;
    }
    .thumb img{width:100%;height:100%;object-fit:cover}
    .fileBtn{
      display:inline-block;
      padding:8px 10px;border-radius:10px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      cursor:pointer;
      font-size:12px;font-weight:800;
      user-select:none;
    }
    .fileBtn input{display:none}

    /* ===== İç özet tablo (PDF’ye girmez) ===== */
    .internalTable{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      overflow:hidden;
    }
    .internalTable th{
      font-size:12px;
      text-align:left;
      color:#dbe7ff;
      background: rgba(255,255,255,.06);
      padding:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      white-space:nowrap;
    }
    .internalTable td{
      padding:10px;
      border-bottom:1px solid rgba(255,255,255,.06);
      vertical-align:middle;
    }
    .internalTable tr:last-child td{border-bottom:none;}
    .internalTable td.num{ text-align:right; white-space:nowrap; }
    .muted{ color: rgba(233,238,247,.65); font-size:12px; }

    /* ====== PDF PRINT: sadece pdfPage bas ====== */
    #pdfPage{ display:none; }
    body.printing .wrap{ display:none !important; }
    body.printing #pdfPage{
      display:block !important;
      background:#fff;
      color:#111;
    }
    @page { size: A4; margin: 10mm; }

    /* ========= PDF: NORMAL çizgi (1px) + birleşik köşe mantığı ========= */
    :root{ --pdf-line: 1px solid #000; }

    .sheet{
      font-family: Arial, sans-serif;
      display:block;
      background:#fff;
      color:#111;
    }

    .pdfHeaderRow{
      display:grid;
      grid-template-columns: 190px 1fr;
      gap: 14px;
      align-items:center;
      margin: 0 0 6px 0;
    }
    .pdfHeaderLogo img{
      width:175px;
      height:auto;
      object-fit:contain;
      display:block;
    }
    .pdfCompanyLine{ display:none; }

    .pdfHeaderInfo{font-size:11px;line-height:1.55;padding-top:0}
    .pdfInfoRow{display:flex;gap:10px;align-items:flex-start}
    .pdfInfoRow b{width:75px;display:inline-block;text-transform:uppercase}

    .pdfTitle{
      text-align:center;
      font-size:14px;
      font-weight:900;
      letter-spacing:.5px;
      text-transform:uppercase;
      padding:7px 0 6px 0;
      border-top: var(--pdf-line);
      border-bottom: var(--pdf-line);
      margin: 6px 0 8px 0;
    }

    /* ÜST BİLGİ */
    .boxTable{
      width:100%;
      border-collapse:collapse;
      font-size:11px;
      margin:0 0 10px 0;
      border: var(--pdf-line);
    }
    .boxTable td, .boxTable th{
      border: var(--pdf-line);
      padding:8px 8px;
      vertical-align:middle;
    }
    .boxTable th{
      background:#fff;
      font-weight:900;
      text-transform:uppercase;
      letter-spacing:.2px;
      white-space:nowrap;
      width: 24%;
      text-align:right;
    }
    .boxTable .val{width: 26%; text-align:left;}

    /* ÜRÜN TABLOSU (alt border YOK -> alt blokla birleşecek) */
    .itemsTable{
      width:100%;
      border-collapse:collapse;
      font-size:11px;
      margin:0;
      border-left: var(--pdf-line);
      border-right: var(--pdf-line);
      border-top: var(--pdf-line);
      border-bottom: none;
    }
    .itemsTable th, .itemsTable td{
      border: var(--pdf-line);
      padding:7px;
      vertical-align:top;
    }
    .itemsTable th{
      font-weight:900;
      text-transform:uppercase;
      letter-spacing:.2px;
      background:#fff;
      color:#000;
      text-align:center;
    }
    .itemsTable td.num{ text-align:right; white-space:nowrap; }
    .itemsTable td.center{ text-align:center; white-space:nowrap; }

    /* ALT BLOK (üst border YOK -> itemsTable ile birleşecek) */
    .bottomGrid{
      display:grid;
      grid-template-columns: 1.6fr 1fr;
      gap:0;
      margin-top:0;
      border-left: var(--pdf-line);
      border-right: var(--pdf-line);
      border-bottom: var(--pdf-line);
      border-top: none;
    }
    .noteBox{
      border-right: var(--pdf-line);
      padding:10px;
      font-size:11px;
      min-height:110px;
    }
    .noteBox b{
      display:block;
      margin-bottom:6px;
      text-transform:uppercase;
      letter-spacing:.2px;
    }

    .totalsBox{
      display:grid;
      grid-template-columns: 1fr 1fr;
    }
    .totalsBox .cell{
      border-top: var(--pdf-line);
      border-left: var(--pdf-line);
      padding:9px 10px;
      font-size:11px;
      min-height:34px;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    .totalsBox .cell:nth-child(1),
    .totalsBox .cell:nth-child(2){ border-top:none; }

    .totalsBox .cell:nth-child(1),
    .totalsBox .cell:nth-child(3),
    .totalsBox .cell:nth-child(5){
      border-left:none;
      font-weight:900;
      text-transform:uppercase;
      letter-spacing:.2px;
    }
    .totalsBox .cell:nth-child(2),
    .totalsBox .cell:nth-child(4),
    .totalsBox .cell:nth-child(6){
      justify-content:flex-end;
      font-weight:900;
      white-space:nowrap;
    }

    /* İMZA (üst border YOK -> üstteki blokla birleşecek) */
    .sheetFooter{ margin-top:0; }

    .signRow{
      width:100%;
      border-collapse:collapse;
      font-size:11px;
      border-left: var(--pdf-line);
      border-right: var(--pdf-line);
      border-bottom: var(--pdf-line);
      border-top: none;
    }
    .signRow td{
      border: var(--pdf-line);
      padding:10px;
      vertical-align:top;
      width:50%;
      min-height:62px;
    }
    .signTitle{
      font-weight:900;
      text-transform:uppercase;
      letter-spacing:.2px;
      margin-bottom:6px;
    }
    .signSmall{ margin-top:4px; }

    .footerLine{
      text-align:center;
      font-size:10px;
      margin-top:6px;
      border-top: var(--pdf-line);
      padding-top:6px;
    }

    /* Görseller sayfası */
    .imgListTable{
      width:100%;
      border-collapse:collapse;
      font-size:11px;
      margin-top: 10px;
      border: var(--pdf-line);
    }
    .imgListTable th, .imgListTable td{
      border: var(--pdf-line);
      padding:8px;
      vertical-align:middle;
    }
    .imgListTable th{
      font-weight:900;
      text-transform:uppercase;
      letter-spacing:.2px;
      color:#000;
      text-align:center;
    }
    .imgListTable td.center{ text-align:center; width:70px; }

    .imgBox{
      width:100%;
      height:120px;
      display:flex;
      align-items:center;
      justify-content:center;
      border: var(--pdf-line);
      background:#fff;
      overflow:hidden;
    }
    .imgBox img{ max-width:100%; max-height:100%; object-fit:contain; }
    .pdfMuted{color:#666;font-size:10px}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Ceviz Art • Fiyat Teklif Sistemi</h1>
        <div class="sub">PDF’de müşteri sadece satış görür. Alış/kâr/maliyet gizli.</div>
      </div>
      <div class="actions">
        <button class="primary" id="btnAdd">+ Ürün</button>
        <button class="primary" id="btnPdf">PDF Oluştur</button>
        <button id="btnSave">Kaydet</button>
        <button id="btnLoad">Yükle</button>
        <button class="danger" id="btnReset">Sıfırla</button>
      </div>
    </header>

    <div class="grid">
      <!-- SOL -->
      <section class="card">
        <h2>Teklif & Müşteri Bilgileri</h2>
        <div class="content">
          <div class="row">
            <div class="field">
              <label>Teklif No</label>
              <input id="quoteNo" placeholder="Örn: 2026-001">
            </div>
            <div class="field">
              <label>Tarih</label>
              <input id="quoteDate" type="date">
            </div>
          </div>

          <div class="divider"></div>

          <div class="row">
            <div class="field">
              <label>Müşteri Firma Adı</label>
              <input id="customerName" placeholder="Örn: Terzi">
            </div>
            <div class="field">
              <label>Firma Yetkilisi</label>
              <input id="customerAuthorized" placeholder="Örn: Adem Sungur">
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label>Telefon</label>
              <input id="customerPhone" placeholder="Örn: 544 900 90 90">
            </div>
            <div class="field">
              <label>Fax</label>
              <input id="customerFax" placeholder="-">
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label>Ödeme Şekli</label>
              <input id="paymentType" placeholder="Örn: Havale">
            </div>
            <div class="field">
              <label>Planlanan Teslim Tarihi</label>
              <input id="deliveryDate" type="date">
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label>Teklif Veren (Ad Soyad)</label>
              <input id="offeredBy" placeholder="Teklif veren">
            </div>
          </div>

          <div class="divider"></div>

          <div class="row">
            <div class="field">
              <label>Para Birimi</label>
              <select id="currency">
                <option value="TRY">₺ (TRY)</option>
                <option value="USD">$ (USD)</option>
                <option value="EUR">€ (EUR)</option>
              </select>
            </div>
            <div class="field">
              <label>PDF’de gösterim</label>
              <select id="pdfPriceMode">
                <option value="EXCL">Sadece KDV Hariç</option>
                <option value="INCL">Sadece KDV Dahil</option>
                <option value="BOTH">Birim KDV Hariç + Dahil (PDF’de KDV Hariç yazar)</option>
              </select>
            </div>
          </div>

          <div class="divider"></div>

          <div class="field">
            <label>Açıklamalar (PDF’de görünür)</label>
            <textarea id="quoteNote" placeholder="Örn: Teklif geçerlilik süresi 7 gündür."></textarea>
          </div>

          <div class="divider"></div>
          <div class="hint">
            Repo kök dizinine <b>logo.png</b> koy. PDF üstünde otomatik çıkar. Sosyal medya PDF’de sabit: <b>ceviz.art.lazer</b>
          </div>
        </div>
      </section>

      <!-- SAĞ -->
      <section class="card">
        <h2>Ürünler (Sadece sen görürsün)</h2>
        <div class="content">
          <div class="pill">Alış/Kâr/KDV burada var — PDF’de YOK</div>

          <div style="margin-top:10px; overflow:auto;">
            <table>
              <thead>
                <tr>
                  <th style="min-width:220px;">Ürün</th>
                  <th class="num" style="min-width:120px;">Alış (KDV hariç)</th>
                  <th class="num" style="min-width:95px;">Alış KDV%</th>
                  <th class="num" style="min-width:150px;">Maliyet (KDV dahil)</th>
                  <th class="num" style="min-width:85px;">Kâr%</th>
                  <th class="num" style="min-width:155px;">Satış Birim (KDV hariç)</th>
                  <th class="num" style="min-width:95px;">Satış KDV%</th>
                  <th class="num" style="min-width:160px;">Satış Birim (KDV dahil)</th>
                  <th class="num" style="min-width:85px;">Adet</th>
                  <th class="num" style="min-width:155px;">Toplam (KDV hariç)</th>
                  <th class="num" style="min-width:155px;">Toplam (KDV dahil)</th>
                  <th class="num" style="min-width:170px;">Görsel</th>
                  <th style="min-width:70px;">Sil</th>
                </tr>
              </thead>
              <tbody id="itemsBody"></tbody>
            </table>
          </div>

          <div class="divider"></div>

          <div class="row" style="gap:10px;">
            <div class="field">
              <label>Genel Toplam (KDV Hariç)</label>
              <input id="sumExcl" readonly>
            </div>
            <div class="field">
              <label>KDV Toplamı (Satış)</label>
              <input id="sumVat" readonly>
            </div>
            <div class="field">
              <label>Genel Toplam (KDV Dahil)</label>
              <input id="sumIncl" readonly>
            </div>
          </div>

          <div class="divider"></div>

          <h2 style="padding:0;margin:0 0 8px 0;">İç Özet (PDF’ye girmez)</h2>
          <div id="internalSummary" style="overflow:auto;"></div>

          <div class="divider"></div>

          <div class="row" style="gap:10px;">
            <div class="field">
              <label>Toplam Maliyet (KDV Dahil)</label>
              <input id="internalTotalCostIncl" readonly>
            </div>
            <div class="field">
              <label>Toplam Kâr (KDV’siz)</label>
              <input id="internalTotalProfitExcl" readonly>
            </div>
            <div class="field">
              <label>Toplam Kâr (KDV’li)</label>
              <input id="internalTotalProfitIncl" readonly>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- ===== PDF ===== -->
  <section id="pdfPage">
    <div id="pdfSheets"></div>
  </section>

  <script>
    // ===== Firma Sabitleri =====
    const CONFIG = {
      companyName: "Ceviz Art",
      phones: ["+90 543 492 68 40", "+90 544 900 74 85"],
      email: "baris.ceviz1@gmail.com",
      address:
        "Taşpazar Mah. 819/Şehit Yücel Demirtaş Sok.\n" +
        "Comertler Apt. No:7/A Merkez / AKSARAY",
      logoPath: "logo.png",
      social: "ceviz.art.lazer"
    };

    const DEFAULT_MARGIN = 60;
    const DEFAULT_SALE_VAT = 20;

    const $ = (id) => document.getElementById(id);
    const currencySymbols = { TRY:"₺", USD:"$", EUR:"€" };

    function todayISO(){
      const d = new Date();
      const tzOffset = d.getTimezoneOffset() * 60000;
      return new Date(Date.now() - tzOffset).toISOString().slice(0,10);
    }
    function toNumber(v){
      if(v === "" || v === null || v === undefined) return 0;
      const s = String(v).trim().replaceAll(".", "").replace(",", ".");
      const n = Number(s);
      return Number.isFinite(n) ? n : 0;
    }
    function fmtMoney(n){
      const cur = $("currency").value;
      const sym = currencySymbols[cur] ?? "";
      const out = Number(n || 0).toLocaleString("tr-TR",{minimumFractionDigits:2,maximumFractionDigits:2});
      return `${out} ${sym}`;
    }
    function esc(s){
      return String(s ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }
    function fileToDataURL(file){
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(String(reader.result || ""));
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    function makeRow(data={}){
      const tr = document.createElement("tr");
      tr.dataset.img = data.img || "";

      tr.innerHTML = `
        <td><input class="mini" data-k="name" placeholder="Örn: Kalem" value="${esc(data.name||"")}"></td>

        <td class="num"><input class="mini num" data-k="buyExcl" inputmode="decimal" placeholder="0,00" value="${esc(data.buyExcl??"")}"></td>
        <td class="num"><input class="mini num" data-k="buyVat" inputmode="numeric" placeholder="20" value="${esc(data.buyVat??"")}"></td>
        <td class="num nowrap"><span data-out="costIncl">0</span></td>

        <td class="num"><input class="mini num" data-k="margin" inputmode="numeric" placeholder="${DEFAULT_MARGIN}" value="${esc(data.margin??"")}"></td>
        <td class="num nowrap"><span data-out="saleUnitExcl">0</span></td>

        <td class="num"><input class="mini num" data-k="saleVat" inputmode="numeric" placeholder="${DEFAULT_SALE_VAT}" value="${esc(data.saleVat??"")}"></td>
        <td class="num nowrap"><span data-out="saleUnitIncl">0</span></td>

        <td class="num"><input class="mini num" data-k="qty" inputmode="numeric" placeholder="0" value="${esc(data.qty??"")}"></td>
        <td class="num nowrap"><span data-out="lineExcl">0</span></td>
        <td class="num nowrap"><span data-out="lineIncl">0</span></td>

        <td class="num">
          <div class="imgCell">
            <div class="thumb" data-out="thumb">${tr.dataset.img ? `<img src="${tr.dataset.img}" alt="">` : `<span style="font-size:10px;color:rgba(233,238,247,.6)">YOK</span>`}</div>
            <label class="fileBtn">
              Yükle
              <input type="file" accept="image/*" data-k="imgFile">
            </label>
            <button class="danger mini" data-act="imgDel" title="Görseli kaldır">X</button>
          </div>
        </td>

        <td><button class="danger mini" data-act="del">Sil</button></td>
      `;

      tr.addEventListener("input", recalc);
      tr.querySelector('[data-act="del"]').addEventListener("click", ()=>{ tr.remove(); recalc(); });

      const imgInput = tr.querySelector('[data-k="imgFile"]');
      imgInput.addEventListener("change", async (e) => {
        const file = e.target.files && e.target.files[0];
        if(!file) return;
        const url = await fileToDataURL(file);
        tr.dataset.img = url;
        tr.querySelector('[data-out="thumb"]').innerHTML = `<img src="${url}" alt="">`;
      });

      tr.querySelector('[data-act="imgDel"]').addEventListener("click", () => {
        tr.dataset.img = "";
        tr.querySelector('[data-out="thumb"]').innerHTML = `<span style="font-size:10px;color:rgba(233,238,247,.6)">YOK</span>`;
        imgInput.value = "";
      });

      return tr;
    }

    function renderInternalSummary(rows){
      const el = document.getElementById("internalSummary");
      if(!el) return;

      if(!rows.length){
        el.innerHTML = `<div class="muted" style="padding:10px;">Henüz ürün yok.</div>`;
        return;
      }

      let html = `
        <table class="internalTable">
          <thead>
            <tr>
              <th>Ürün</th>
              <th class="num">Adet</th>

              <th class="num">Tek Maliyet<br><span class="muted">(KDV Dahil)</span></th>
              <th class="num">Toplam Maliyet<br><span class="muted">(KDV Dahil)</span></th>

              <th class="num">Tek Satış<br><span class="muted">(KDV’siz)</span></th>
              <th class="num">Tek Satış<br><span class="muted">(KDV’li)</span></th>

              <th class="num">Toplam Satış<br><span class="muted">(KDV’siz)</span></th>
              <th class="num">Toplam Satış<br><span class="muted">(KDV’li)</span></th>

              <th class="num">Toplam Kâr<br><span class="muted">(KDV’siz)</span></th>
              <th class="num">Toplam Kâr<br><span class="muted">(KDV’li)</span></th>

              <th class="num">Kâr Marjı</th>
            </tr>
          </thead>
          <tbody>
      `;

      for(const r of rows){
        html += `
          <tr>
            <td>${esc(r.name)}</td>
            <td class="num">${Number(r.qty || 0)}</td>

            <td class="num">${fmtMoney(r.unitCostIncl)}</td>
            <td class="num">${fmtMoney(r.totalCostIncl)}</td>

            <td class="num">${fmtMoney(r.unitSaleExcl)}</td>
            <td class="num">${fmtMoney(r.unitSaleIncl)}</td>

            <td class="num">${fmtMoney(r.totalSaleExcl)}</td>
            <td class="num">${fmtMoney(r.totalSaleIncl)}</td>

            <td class="num">${fmtMoney(r.profitExcl)}</td>
            <td class="num">${fmtMoney(r.profitIncl)}</td>

            <td class="num">${(r.profitMarginPct || 0).toLocaleString("tr-TR",{minimumFractionDigits:1,maximumFractionDigits:1})}%</td>
          </tr>
        `;
      }

      html += `</tbody></table>`;
      el.innerHTML = html;
    }

    function recalc(){
      let sumExcl=0, sumIncl=0, sumVat=0;
      const rows = Array.from($("itemsBody").querySelectorAll("tr"));

      let internalRows = [];
      let internalTotalCostIncl = 0;
      let internalTotalProfitExcl = 0;
      let internalTotalProfitIncl = 0;

      for(const tr of rows){
        const buyExcl = toNumber(tr.querySelector('[data-k="buyExcl"]').value);
        const buyVat  = toNumber(tr.querySelector('[data-k="buyVat"]').value);
        const costIncl = buyExcl * (1 + buyVat/100);

        let margin = tr.querySelector('[data-k="margin"]').value;
        margin = margin === "" ? DEFAULT_MARGIN : toNumber(margin);

        const saleUnitExcl = buyExcl * (1 + margin/100);

        let saleVat = tr.querySelector('[data-k="saleVat"]').value;
        saleVat = saleVat === "" ? DEFAULT_SALE_VAT : toNumber(saleVat);

        const saleUnitIncl = saleUnitExcl * (1 + saleVat/100);

        const qty = toNumber(tr.querySelector('[data-k="qty"]').value);

        const lineExcl = saleUnitExcl * qty;
        const lineIncl = saleUnitIncl * qty;

        tr.querySelector('[data-out="costIncl"]').textContent = fmtMoney(costIncl);
        tr.querySelector('[data-out="saleUnitExcl"]').textContent = fmtMoney(saleUnitExcl);
        tr.querySelector('[data-out="saleUnitIncl"]').textContent = fmtMoney(saleUnitIncl);
        tr.querySelector('[data-out="lineExcl"]').textContent = fmtMoney(lineExcl);
        tr.querySelector('[data-out="lineIncl"]').textContent = fmtMoney(lineIncl);

        sumExcl += lineExcl;
        sumIncl += lineIncl;
        sumVat  += (lineIncl - lineExcl);

        const name = tr.querySelector('[data-k="name"]').value.trim() || "-";

        const unitCostIncl = costIncl;
        const totalCostIncl = unitCostIncl * qty;

        const unitSaleExcl = saleUnitExcl;
        const unitSaleIncl = saleUnitIncl;

        const totalSaleExcl = lineExcl;
        const totalSaleIncl = lineIncl;

        const buyTotalExcl = buyExcl * qty;
        const profitExcl = totalSaleExcl - buyTotalExcl;
        const profitIncl = totalSaleIncl - totalCostIncl;

        const profitMarginPct = totalSaleExcl > 0 ? (profitExcl / totalSaleExcl) * 100 : 0;

        internalRows.push({
          name, qty,
          unitCostIncl, totalCostIncl,
          unitSaleExcl, unitSaleIncl,
          totalSaleExcl, totalSaleIncl,
          profitExcl, profitIncl,
          profitMarginPct
        });

        internalTotalCostIncl += totalCostIncl;
        internalTotalProfitExcl += profitExcl;
        internalTotalProfitIncl += profitIncl;
      }

      $("sumExcl").value = fmtMoney(sumExcl);
      $("sumVat").value  = fmtMoney(sumVat);
      $("sumIncl").value = fmtMoney(sumIncl);

      renderInternalSummary(internalRows);
      $("internalTotalCostIncl").value = fmtMoney(internalTotalCostIncl);
      $("internalTotalProfitExcl").value = fmtMoney(internalTotalProfitExcl);
      $("internalTotalProfitIncl").value = fmtMoney(internalTotalProfitIncl);
    }

    function buildPdfSheets(){
      const wrap = $("pdfSheets");
      wrap.innerHTML = "";

      const firmName = $("customerName").value || "";
      const customerAuth = $("customerAuthorized").value || "";
      const customerPhone = $("customerPhone").value || "";
      const customerFax = $("customerFax").value || "";

      const quoteNo = $("quoteNo").value || "";
      const quoteDate = $("quoteDate").value || "";
      const paymentType = $("paymentType").value || "";
      const deliveryDate = $("deliveryDate").value || "";
      const note = $("quoteNote").value?.trim() || "";
      const offeredBy = $("offeredBy").value?.trim() || "";

      const totalExcl = $("sumExcl").value || fmtMoney(0);
      const totalVat = $("sumVat").value || fmtMoney(0);
      const totalIncl = $("sumIncl").value || fmtMoney(0);

      const items = [];
      const rows = Array.from($("itemsBody").querySelectorAll("tr"));
      for(const tr of rows){
        const name = tr.querySelector('[data-k="name"]').value.trim();
        if(!name) continue;

        const qty = tr.querySelector('[data-k="qty"]').value || "0";
        const unitExcl = tr.querySelector('[data-out="saleUnitExcl"]').textContent;
        const unitIncl = tr.querySelector('[data-out="saleUnitIncl"]').textContent;
        const lineExcl = tr.querySelector('[data-out="lineExcl"]').textContent;
        const lineIncl = tr.querySelector('[data-out="lineIncl"]').textContent;
        const img = tr.dataset.img || "";
        items.push({ name, qty, unitExcl, unitIncl, lineExcl, lineIncl, img });
      }

      const mode = $("pdfPriceMode").value; // EXCL/INCL/BOTH
      const priceModeForTemplate = (mode === "INCL") ? "INCL" : "EXCL";

      // ===== 1. sayfa =====
      const sheet1 = document.createElement("div");
      sheet1.className = "sheet";

      sheet1.innerHTML = `
        <div class="sheetBody">
          <div class="pdfHeaderRow">
            <div class="pdfHeaderLogo">
              <img src="${esc(CONFIG.logoPath)}" alt="Logo">
              <div class="pdfCompanyLine">${esc(CONFIG.companyName).toUpperCase()}</div>
            </div>

            <div class="pdfHeaderInfo">
              <div class="pdfInfoRow"><b>Adres</b><span>: ${esc(CONFIG.address).replaceAll("\n"," ")}</span></div>
              <div class="pdfInfoRow"><b>Telefon</b><span>: ${esc(CONFIG.phones.join(" / "))}</span></div>
              <div class="pdfInfoRow"><b>E-posta</b><span>: ${esc(CONFIG.email)}</span></div>
              <div class="pdfInfoRow"><b>Sosyal</b><span>: ${esc(CONFIG.social)}</span></div>
            </div>
          </div>

          <div class="pdfTitle">MÜŞTERİ TEKLİF VE SİPARİŞ FORMU</div>

          <table class="boxTable">
            <tr>
              <th>FİRMA ADI</th>
              <td class="val">${esc(firmName || "-")}</td>
              <th>TEKLİF / SİPARİŞ NO</th>
              <td class="val">${esc(quoteNo || "-")}</td>
            </tr>
            <tr>
              <th>FİRMA YETKİLİSİ</th>
              <td class="val">${esc(customerAuth || "-")}</td>
              <th>TEKLİF TARİHİ</th>
              <td class="val">${esc(quoteDate || "-")}</td>
            </tr>
            <tr>
              <th>TELEFON</th>
              <td class="val">${esc(customerPhone || "-")}</td>
              <th>ÖDEME ŞEKLİ</th>
              <td class="val">${esc(paymentType || "-")}</td>
            </tr>
            <tr>
              <th>FAX</th>
              <td class="val">${esc(customerFax || "-")}</td>
              <th>PLANLANAN TESLİM TARİHİ</th>
              <td class="val">${esc(deliveryDate || "-")}</td>
            </tr>
          </table>

          <table class="itemsTable">
            <thead>
              <tr>
                <th class="center" style="width:70px;">NO</th>
                <th>İŞİN ADI</th>
                <th class="center" style="width:110px;">MİKTARI</th>
                <th class="num" style="width:140px;">BR. FİYATI</th>
                <th class="num" style="width:150px;">TUTARI</th>
              </tr>
            </thead>
            <tbody id="pdfItemsBody"></tbody>
          </table>

          <div class="bottomGrid">
            <div class="noteBox">
              <b>AÇIKLAMALAR:</b>
              <div>${esc(note || "-").replaceAll("\n","<br>")}</div>
            </div>

            <div class="totalsBox">
              <div class="cell">TOPLAM TUTAR</div>
              <div class="cell">${esc(priceModeForTemplate==="EXCL" ? totalExcl : totalIncl)}</div>
              <div class="cell">${DEFAULT_SALE_VAT}% KDV</div>
              <div class="cell">${esc(totalVat)}</div>
              <div class="cell">GENEL TOPLAM</div>
              <div class="cell">${esc(totalIncl)}</div>
            </div>
          </div>
        </div>

        <div class="sheetFooter">
          <table class="signRow">
            <tr>
              <td>
                <div class="signTitle">SİPARİŞ ALAN / TEKLİF VEREN</div>
                <div>Adı-Soyadı: ${esc(offeredBy || "-")}</div>
                <div class="signSmall">İmza:</div>
              </td>
              <td>
                <div class="signTitle">MÜŞTERİ ONAYI</div>
                <div>Adı-Soyadı: ____________________</div>
                <div class="signSmall">İmza:</div>
                <div class="signSmall">(LÜTFEN TEYİD EDİNİZ.)</div>
              </td>
            </tr>
          </table>

          <div class="footerLine">
            Tüm lazer kesim - uv baskı - lazer baskı - soğuk etiket - tekstil - promosyon gibi baskı ihtiyaçlarınız için lütfen iletişime geçiniz
          </div>
        </div>
      `;
      wrap.appendChild(sheet1);

      const pdfItemsBody = sheet1.querySelector("#pdfItemsBody");
      pdfItemsBody.innerHTML = "";

      items.forEach((it, idx) => {
        const unit = (priceModeForTemplate === "INCL") ? it.unitIncl : it.unitExcl;
        const line = (priceModeForTemplate === "INCL") ? it.lineIncl : it.lineExcl;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="center">${idx+1}</td>
          <td>${esc(it.name)}</td>
          <td class="center">${esc(it.qty)}</td>
          <td class="num">${esc(unit)}</td>
          <td class="num">${esc(line)}</td>
        `;
        pdfItemsBody.appendChild(tr);
      });

      // ===== görseller sayfaları =====
      const imgItems = items.filter(x => x.name);
      if(imgItems.length){
        const perPage = 4;
        for(let p=0; p<imgItems.length; p+=perPage){
          const chunk = imgItems.slice(p, p+perPage);

          const sheet = document.createElement("div");
          sheet.className = "sheet";
          sheet.style.pageBreakBefore = "always";

          sheet.innerHTML = `
            <div class="sheetBody">
              <div class="pdfHeaderRow">
                <div class="pdfHeaderLogo">
                  <img src="${esc(CONFIG.logoPath)}" alt="Logo">
                  <div class="pdfCompanyLine">${esc(CONFIG.companyName).toUpperCase()}</div>
                </div>

                <div class="pdfHeaderInfo">
                  <div style="font-weight:900; font-size:12px; text-transform:uppercase;">ÜRÜN GÖRSELLERİ</div>
                  <div style="margin-top:6px;">Teklif No: <b>${esc(quoteNo||"-")}</b> • Tarih: <b>${esc(quoteDate||"-")}</b></div>
                  <div style="margin-top:2px;">Firma: <b>${esc(firmName||"-")}</b></div>
                  <div style="margin-top:2px;">Sosyal: <b>${esc(CONFIG.social)}</b></div>
                </div>
              </div>

              <table class="imgListTable">
                <thead>
                  <tr>
                    <th class="center">NO</th>
                    <th>ÜRÜN</th>
                    <th style="width:60%;">FOTOĞRAF</th>
                  </tr>
                </thead>
                <tbody id="imgBody"></tbody>
              </table>
            </div>

            <div class="sheetFooter">
              <table class="signRow">
                <tr>
                  <td>
                    <div class="signTitle">SİPARİŞ ALAN / TEKLİF VEREN</div>
                    <div>Adı-Soyadı: ${esc(offeredBy || "-")}</div>
                    <div class="signSmall">İmza:</div>
                  </td>
                  <td>
                    <div class="signTitle">MÜŞTERİ ONAYI</div>
                    <div>Adı-Soyadı: ____________________</div>
                    <div class="signSmall">İmza:</div>
                    <div class="signSmall">(LÜTFEN TEYİD EDİNİZ.)</div>
                  </td>
                </tr>
              </table>

              <div class="footerLine">
                Tüm lazer kesim - uv baskı - lazer baskı - soğuk etiket - tekstil - promosyon gibi baskı ihtiyaçlarınız için lütfen iletişime geçiniz
              </div>
            </div>
          `;
          wrap.appendChild(sheet);

          const imgBody = sheet.querySelector("#imgBody");
          chunk.forEach((it, idx2) => {
            const globalNo = p + idx2 + 1;
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td class="center">${globalNo}</td>
              <td>${esc(it.name)}</td>
              <td>
                <div class="imgBox">
                  ${it.img ? `<img src="${it.img}" alt="${esc(it.name)}">` : `<span class="pdfMuted">Görsel eklenmedi</span>`}
                </div>
              </td>
            `;
            imgBody.appendChild(tr);
          });
        }
      }
    }

    function printPdf(){
      recalc();
      buildPdfSheets();
      document.body.classList.add("printing");
      requestAnimationFrame(()=> setTimeout(()=> window.print(), 60));
    }
    window.addEventListener("afterprint", ()=> {
      document.body.classList.remove("printing");
    });

    // Save/Load
    const KEY="cevizart_quote_final_fullcode";
    function collect(){
      const rows = Array.from($("itemsBody").querySelectorAll("tr")).map(tr => ({
        name: tr.querySelector('[data-k="name"]').value,
        buyExcl: tr.querySelector('[data-k="buyExcl"]').value,
        buyVat: tr.querySelector('[data-k="buyVat"]').value,
        margin: tr.querySelector('[data-k="margin"]').value,
        saleVat: tr.querySelector('[data-k="saleVat"]').value,
        qty: tr.querySelector('[data-k="qty"]').value,
        img: tr.dataset.img || ""
      }));
      return {
        meta:{
          quoteNo:$("quoteNo").value,
          quoteDate:$("quoteDate").value,
          customerName:$("customerName").value,
          customerAuthorized:$("customerAuthorized").value,
          customerPhone:$("customerPhone").value,
          customerFax:$("customerFax").value,
          paymentType:$("paymentType").value,
          deliveryDate:$("deliveryDate").value,
          offeredBy:$("offeredBy").value,
          quoteNote:$("quoteNote").value,
          currency:$("currency").value,
          pdfPriceMode:$("pdfPriceMode").value,
        },
        rows
      };
    }
    function apply(data){
      const m=data?.meta||{};
      $("quoteNo").value = m.quoteNo||"";
      $("quoteDate").value = m.quoteDate||todayISO();
      $("customerName").value = m.customerName||"";
      $("customerAuthorized").value = m.customerAuthorized||"";
      $("customerPhone").value = m.customerPhone||"";
      $("customerFax").value = m.customerFax||"";
      $("paymentType").value = m.paymentType||"";
      $("deliveryDate").value = m.deliveryDate||todayISO();
      $("offeredBy").value = m.offeredBy||"Barış Ceviz";
      $("quoteNote").value = m.quoteNote||"";
      $("currency").value = m.currency ?? "TRY";
      $("pdfPriceMode").value = m.pdfPriceMode ?? "EXCL";

      $("itemsBody").innerHTML="";
      (data?.rows||[]).forEach(r => $("itemsBody").appendChild(makeRow(r)));
      if(($("itemsBody").children.length||0)===0) $("itemsBody").appendChild(makeRow());
      recalc();
    }
    function save(){ localStorage.setItem(KEY, JSON.stringify(collect())); }
    function load(){
      const raw=localStorage.getItem(KEY);
      if(!raw) return;
      try{ apply(JSON.parse(raw)); }catch(e){}
    }
    function resetAll(){
      localStorage.removeItem(KEY);
      $("quoteNo").value="";
      $("quoteDate").value=todayISO();
      $("customerName").value="";
      $("customerAuthorized").value="";
      $("customerPhone").value="";
      $("customerFax").value="";
      $("paymentType").value="";
      $("deliveryDate").value=todayISO();
      $("offeredBy").value="Barış Ceviz";
      $("quoteNote").value="";
      $("currency").value="TRY";
      $("pdfPriceMode").value="EXCL";
      $("itemsBody").innerHTML="";
      $("itemsBody").appendChild(makeRow());
      recalc();
    }

    (function init(){
      $("quoteDate").value = todayISO();
      $("deliveryDate").value = todayISO();
      $("offeredBy").value = "Barış Ceviz";

      $("itemsBody").appendChild(makeRow());
      load();
      recalc();

      $("btnAdd").addEventListener("click", ()=>{ $("itemsBody").appendChild(makeRow()); recalc(); });
      $("btnPdf").addEventListener("click", printPdf);
      $("btnSave").addEventListener("click", save);
      $("btnLoad").addEventListener("click", load);
      $("btnReset").addEventListener("click", resetAll);

      ["currency","pdfPriceMode"].forEach(id => $(id).addEventListener("input", recalc));
    })();
  </script>
</body>
</html>
