<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ceviz Art • Fiyat Teklif Sistemi</title>

  <style>
    :root{
      --bg:#0b1220; --card:#0f1a2e; --muted:#a9b4c7; --text:#e9eef7;
      --line:rgba(255,255,255,.10); --shadow: 0 16px 40px rgba(0,0,0,.35);
      --radius:16px; --danger:#fb7185;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 600px at 20% 0%, rgba(96,165,250,.18), transparent 60%),
                  radial-gradient(900px 600px at 90% 10%, rgba(94,234,212,.14), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1280px;margin:0 auto;padding:24px}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:18px}
    h1{font-size:18px;margin:0}
    .sub{font-size:13px;color:var(--muted);margin-top:2px}
    .actions{display:flex;gap:10px;flex-wrap:wrap}
    button{
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      transition:.15s transform, .15s background;
      font-weight:800;
    }
    button:hover{transform: translateY(-1px); background: rgba(255,255,255,.09)}
    button.primary{
      background: linear-gradient(135deg, rgba(94,234,212,.22), rgba(96,165,250,.22));
      border-color: rgba(94,234,212,.35);
    }
    button.danger{border-color: rgba(251,113,133,.35); background: rgba(251,113,133,.10)}

    .grid{display:grid;grid-template-columns: 460px 1fr;gap:16px;align-items:start}
    @media (max-width: 1020px){ .grid{grid-template-columns:1fr} }

    .card{
      background: rgba(15,26,46,.86);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card h2{font-size:14px;margin:0;padding:14px 14px 0 14px;color:#dbe7ff}
    .content{padding:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .field{flex:1;min-width:160px}
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px 0}
    input, textarea, select{
      width:100%;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 10px;
      border-radius:12px;
      outline:none;
    }
    textarea{min-height:86px;resize:vertical}
    .divider{height:1px;background:var(--line);margin:12px 0}
    .hint{font-size:12px;color:var(--muted);line-height:1.35}

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      border:1px solid var(--line);
      border-radius: 14px;
      overflow:hidden;
    }
    thead th{
      font-size:12px;
      text-align:left;
      color:#dbe7ff;
      background: rgba(255,255,255,.06);
      padding:10px;
      border-bottom:1px solid var(--line);
      white-space:nowrap;
    }
    tbody td{padding:8px;border-bottom:1px solid rgba(255,255,255,.06);vertical-align:middle}
    tbody tr:last-child td{border-bottom:none}
    .mini{padding:8px 8px;border-radius:10px;font-size:13px}
    .num{text-align:right}
    .nowrap{white-space:nowrap}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      padding:8px 10px;border-radius:999px;
      font-size:12px;color:var(--muted);
    }

    /* ====== PDF: tek sayfa fatura gibi ====== */
    #pdfPage{ display:none; }

    /* ✅ Basarken: ana ekran tamamen KAPANIR, sadece pdfPage görünür */
    body.printing .wrap{ display:none !important; }
    body.printing #pdfPage{
    display:block !important;
    position:static !important;   /* absolute olmasın -> sayfa kaydırma/boş sayfa yapmasın */
    width:auto !important;
    background:#fff;
    color:#111;
    }

    /* Normalde pdf sayfası kapalı */
    #pdfPage{ display:none; }


    @page { size: A4; margin: 10mm; }
    @media print{
      body{ background:#fff; }
      .wrap, header, .card{ box-shadow:none !important; }
    }

    /* PDF Layout */
    .pdfWrap{ font-family: Arial, sans-serif; }
    .pdfTitle{
      text-align:center;
      font-size:18px;
      font-weight:800;
      letter-spacing:.6px;
      margin:0 0 8px 0;
    }
    .pdfTop{
      display:grid;
      grid-template-columns: 1fr 1.2fr 1fr; /* sol kaşe, orta logo, sağ firma */
      gap:8px;
      align-items:center;
      margin-bottom:8px;
    }
    .pdfBox{
      border:1px solid #ddd;
      border-radius:10px;
      padding:8px;
      min-height:72px;
    }
    .pdfLogo, .pdfStamp{
      display:flex; align-items:center; justify-content:center;
      min-height:56px;
    }
    .pdfLogo img, .pdfStamp img{ max-height:56px; max-width:100%; object-fit:contain; }
    .pdfInfo{
      font-size:10.5px;
      line-height:1.25;
      white-space:pre-line;
    }
    .pdfMeta{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:8px;
      margin-bottom:8px;
    }
    .pdfMeta .pdfBox{ min-height:auto; }

    .pdfTable{
      width:100%;
      border-collapse:collapse;
      font-size:10.5px;
    }
    .pdfTable th, .pdfTable td{
      border:1px solid #ddd;
      padding:6px;
      vertical-align:top;
    }
    .pdfTable th{
      background:#f3f4f6;
      font-weight:800;
      text-align:left;
    }
    .pdfTable td.num, .pdfTable th.num{ text-align:right; white-space:nowrap; }
    .pdfTotals{
      margin-top:8px;
      display:flex;
      justify-content:flex-end;
    }
    .pdfTotalsBox{
      width:320px;
      border:1px solid #ddd;
      border-radius:10px;
      padding:8px;
      font-size:11px;
    }
    .pdfTotalsRow{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:2px 0;
    }
    .pdfTotalsRow b{ font-weight:800; }
    .pdfNote{
      margin-top:8px;
      border:1px solid #ddd;
      border-radius:10px;
      padding:8px;
      font-size:10.5px;
      white-space:pre-line;
    }
    .pdfFooter{
      margin-top:6px;
      text-align:center;
      font-size:10px;
      color:#333;
    }

    /* Tek sayfa için: satır bölünmesin */
    .pdfTable tr{ page-break-inside: avoid; break-inside: avoid; }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Ceviz Art • Fiyat Teklif Sistemi</h1>
        <div class="sub">PDF’de müşteri sadece satış görür. Alış/kâr/maliyet gizli.</div>
      </div>
      <div class="actions">
        <button class="primary" id="btnAdd">+ Ürün</button>
        <button class="primary" id="btnPdf">PDF Oluştur</button>
        <button id="btnSave">Kaydet</button>
        <button id="btnLoad">Yükle</button>
        <button class="danger" id="btnReset">Sıfırla</button>
      </div>
    </header>

    <div class="grid">
      <!-- SOL: müşteri/teklif -->
      <section class="card">
        <h2>Teklif & Müşteri Bilgileri</h2>
        <div class="content">
          <div class="row">
            <div class="field">
              <label>Teklif No</label>
              <input id="quoteNo" placeholder="Örn: 2026-001">
            </div>
            <div class="field">
              <label>Tarih</label>
              <input id="quoteDate" type="date">
            </div>
          </div>

          <div class="divider"></div>

          <div class="row">
            <div class="field">
              <label>Müşteri Firma Adı</label>
              <input id="customerName" placeholder="Örn: ABC İnşaat">
            </div>
            <div class="field">
              <label>Müşteri Telefon</label>
              <input id="customerPhone" placeholder="+90 ...">
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label>Müşteri E-posta</label>
              <input id="customerEmail" placeholder="mail@...">
            </div>
            <div class="field">
              <label>Müşteri Adres</label>
              <input id="customerAddress" placeholder="Adres...">
            </div>
          </div>

          <div class="divider"></div>

          <h2 style="padding:0;margin:0 0 8px 0;">Ürün Hesap Ayarları</h2>
          <div class="row">
            <div class="field">
              <label>Varsayılan Kâr (%)</label>
              <input id="defaultMargin" type="number" min="0" step="1" value="60">
            </div>
            <div class="field">
              <label>Varsayılan Satış KDV (%)</label>
              <input id="defaultSaleVat" type="number" min="0" step="1" value="20">
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label>Para Birimi</label>
              <select id="currency">
                <option value="TRY">₺ (TRY)</option>
                <option value="USD">$ (USD)</option>
                <option value="EUR">€ (EUR)</option>
              </select>
            </div>
            <div class="field">
              <label>PDF’de gösterim</label>
              <select id="pdfPriceMode">
                <option value="BOTH">Birim KDV Hariç + Dahil</option>
                <option value="INCL">Sadece KDV Dahil</option>
                <option value="EXCL">Sadece KDV Hariç</option>
              </select>
            </div>
          </div>

          <div class="divider"></div>

          <div class="field">
            <label>Not (PDF’de görünür)</label>
            <textarea id="quoteNote" placeholder="Örn: Geçerlilik 7 gün, teslim 3 iş günü..."></textarea>
          </div>

          <div class="divider"></div>
          <div class="hint">
            Repo kök dizinine <b>logo.png</b> ve <b>kase.png</b> koy. PDF üstünde otomatik çıkar.
          </div>
        </div>
      </section>

      <!-- SAĞ: İÇ EKRAN (senin panelin) -->
      <section class="card">
        <h2>Ürünler (Sadece sen görürsün)</h2>
        <div class="content">
          <div class="pill">Alış/Kâr/KDV burada var — PDF’de YOK</div>

          <div style="margin-top:10px; overflow:auto;">
            <table>
              <thead>
                <tr>
                  <th style="min-width:220px;">Ürün</th>
                  <th class="num" style="min-width:120px;">Alış (KDV hariç)</th>
                  <th class="num" style="min-width:95px;">Alış KDV%</th>
                  <th class="num" style="min-width:150px;">Maliyet (KDV dahil)</th>
                  <th class="num" style="min-width:85px;">Kâr%</th>
                  <th class="num" style="min-width:155px;">Satış Birim (KDV hariç)</th>
                  <th class="num" style="min-width:95px;">Satış KDV%</th>
                  <th class="num" style="min-width:160px;">Satış Birim (KDV dahil)</th>
                  <th class="num" style="min-width:85px;">Adet</th>
                  <th class="num" style="min-width:155px;">Toplam (KDV hariç)</th>
                  <th class="num" style="min-width:155px;">Toplam (KDV dahil)</th>
                  <th style="min-width:70px;">Sil</th>
                </tr>
              </thead>
              <tbody id="itemsBody"></tbody>
            </table>
          </div>

          <div class="divider"></div>

          <div class="row" style="gap:10px;">
            <div class="field">
              <label>Genel Toplam (KDV Hariç)</label>
              <input id="sumExcl" readonly>
            </div>
            <div class="field">
              <label>KDV Toplamı (Satış)</label>
              <input id="sumVat" readonly>
            </div>
            <div class="field">
              <label>Genel Toplam (KDV Dahil)</label>
              <input id="sumIncl" readonly>
            </div>
          </div>

          <div style="text-align:center;margin-top:14px;color:rgba(233,238,247,.75);font-size:12px;">M.K.</div>
        </div>
      </section>
    </div>
  </div>

  <!-- ======== PDF SAYFASI (Sadece bu basılır) ======== -->
  <section id="pdfPage">
    <div class="pdfWrap">
      <div class="pdfTitle">FİYAT TEKLİFİ</div>

      <div class="pdfTop">
        <div class="pdfBox">
          <div style="font-size:10px;color:#555;margin-bottom:6px;"><b>Kaşe / İmza</b></div>
          <div class="pdfStamp" id="pStamp"></div>
        </div>

        <div class="pdfBox">
          <div style="font-size:10px;color:#555;margin-bottom:6px;text-align:center;"><b>Logo</b></div>
          <div class="pdfLogo" id="pLogo"></div>
        </div>

        <div class="pdfBox">
          <div style="font-size:10px;color:#555;margin-bottom:6px;"><b>Firma Bilgileri</b></div>
          <div class="pdfInfo" id="pCompany"></div>
        </div>
      </div>

      <div class="pdfMeta">
        <div class="pdfBox">
          <div class="pdfInfo" id="pCustomer"></div>
        </div>
        <div class="pdfBox">
          <div class="pdfInfo" id="pQuote"></div>
        </div>
      </div>

      <table class="pdfTable">
        <thead>
          <tr>
            <th>Ürün</th>
            <th class="num" id="pThUnitExcl">Birim (KDV Hariç)</th>
            <th class="num" id="pThUnitIncl">Birim (KDV Dahil)</th>
            <th class="num">Adet</th>
            <th class="num" id="pThLineExcl">Toplam (KDV Hariç)</th>
            <th class="num" id="pThLineIncl">Toplam (KDV Dahil)</th>
          </tr>
        </thead>
        <tbody id="pItems"></tbody>
      </table>

      <div class="pdfTotals">
        <div class="pdfTotalsBox">
          <div class="pdfTotalsRow"><span>Ara Toplam (KDV Hariç)</span><b id="pSumExcl">0</b></div>
          <div class="pdfTotalsRow"><span>KDV Toplamı</span><b id="pSumVat">0</b></div>
          <div class="pdfTotalsRow" style="border-top:1px solid #ddd;margin-top:6px;padding-top:6px;">
            <span>Genel Toplam (KDV Dahil)</span><b id="pSumIncl">0</b>
          </div>
        </div>
      </div>

      <div class="pdfNote" id="pNote">-</div>
      <div class="pdfFooter">M.K.</div>
    </div>
  </section>

  <script>
    // ===== Sabit Firma Bilgileri (senin verdiğin) =====
    const CONFIG = {
      companyName: "Ceviz Art",
      phones: ["+90 543 492 68 40", "+90 544 900 74 85"],
      email: "baris.ceviz1@gmail.com",
      address:
        "Taşpazar Mah. 819/Şehit Yücel Demirtaş Sok.\n" +
        "Comertler Apt. No:7/A Merkez / AKSARAY",
      logoPath: "logo.png",
      stampPath: "kase.png",
    };

    const $ = (id) => document.getElementById(id);
    const currencySymbols = { TRY:"₺", USD:"$", EUR:"€" };

    function todayISO(){
      const d = new Date();
      const tzOffset = d.getTimezoneOffset() * 60000;
      return new Date(Date.now() - tzOffset).toISOString().slice(0,10);
    }
    function toNumber(v){
      if(v === "" || v === null || v === undefined) return 0;
      const s = String(v).trim().replaceAll(".", "").replace(",", ".");
      const n = Number(s);
      return Number.isFinite(n) ? n : 0;
    }
    function fmtMoney(n){
      const cur = $("currency").value;
      const sym = currencySymbols[cur] ?? "";
      const out = Number(n || 0).toLocaleString("tr-TR",{minimumFractionDigits:2,maximumFractionDigits:2});
      return `${out} ${sym}`;
    }
    function esc(s){
      return String(s ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    function makeRow(data={}){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input class="mini" data-k="name" placeholder="Örn: Kalem" value="${esc(data.name||"")}"></td>

        <td class="num"><input class="mini num" data-k="buyExcl" inputmode="decimal" placeholder="0,00" value="${esc(data.buyExcl??"")}"></td>
        <td class="num"><input class="mini num" data-k="buyVat" inputmode="numeric" placeholder="20" value="${esc(data.buyVat??"")}"></td>
        <td class="num nowrap"><span data-out="costIncl">0</span></td>

        <td class="num"><input class="mini num" data-k="margin" inputmode="numeric" placeholder="${$("defaultMargin").value}" value="${esc(data.margin??"")}"></td>
        <td class="num nowrap"><span data-out="saleUnitExcl">0</span></td>

        <td class="num"><input class="mini num" data-k="saleVat" inputmode="numeric" placeholder="${$("defaultSaleVat").value}" value="${esc(data.saleVat??"")}"></td>
        <td class="num nowrap"><span data-out="saleUnitIncl">0</span></td>

        <td class="num"><input class="mini num" data-k="qty" inputmode="numeric" placeholder="0" value="${esc(data.qty??"")}"></td>
        <td class="num nowrap"><span data-out="lineExcl">0</span></td>
        <td class="num nowrap"><span data-out="lineIncl">0</span></td>

        <td><button class="danger mini" data-act="del">Sil</button></td>
      `;
      tr.addEventListener("input", recalc);
      tr.querySelector('[data-act="del"]').addEventListener("click", ()=>{ tr.remove(); recalc(); });
      return tr;
    }

    function recalc(){
      let sumExcl=0, sumIncl=0, sumVat=0;
      const rows = Array.from($("itemsBody").querySelectorAll("tr"));

      for(const tr of rows){
        const buyExcl = toNumber(tr.querySelector('[data-k="buyExcl"]').value);
        const buyVat  = toNumber(tr.querySelector('[data-k="buyVat"]').value);
        const costIncl = buyExcl * (1 + buyVat/100);

        let margin = tr.querySelector('[data-k="margin"]').value;
        margin = margin === "" ? toNumber($("defaultMargin").value) : toNumber(margin);

        const saleUnitExcl = buyExcl * (1 + margin/100);

        let saleVat = tr.querySelector('[data-k="saleVat"]').value;
        saleVat = saleVat === "" ? toNumber($("defaultSaleVat").value) : toNumber(saleVat);

        const saleUnitIncl = saleUnitExcl * (1 + saleVat/100);

        const qty = toNumber(tr.querySelector('[data-k="qty"]').value);

        const lineExcl = saleUnitExcl * qty;
        const lineIncl = saleUnitIncl * qty;

        tr.querySelector('[data-out="costIncl"]').textContent = fmtMoney(costIncl);
        tr.querySelector('[data-out="saleUnitExcl"]').textContent = fmtMoney(saleUnitExcl);
        tr.querySelector('[data-out="saleUnitIncl"]').textContent = fmtMoney(saleUnitIncl);
        tr.querySelector('[data-out="lineExcl"]').textContent = fmtMoney(lineExcl);
        tr.querySelector('[data-out="lineIncl"]').textContent = fmtMoney(lineIncl);

        sumExcl += lineExcl;
        sumIncl += lineIncl;
        sumVat  += (lineIncl - lineExcl);
      }

      $("sumExcl").value = fmtMoney(sumExcl);
      $("sumVat").value  = fmtMoney(sumVat);
      $("sumIncl").value = fmtMoney(sumIncl);

      // PDF totals
      $("pSumExcl").textContent = fmtMoney(sumExcl);
      $("pSumVat").textContent  = fmtMoney(sumVat);
      $("pSumIncl").textContent = fmtMoney(sumIncl);
    }

    function buildPdfData(){
      // üst bilgiler
      const phones = CONFIG.phones.filter(Boolean).join(" / ");
      $("pCompany").textContent =
        `${CONFIG.companyName}\n` +
        `Tel: ${phones}\n` +
        `Mail: ${CONFIG.email}\n` +
        `Adres:\n${CONFIG.address}`;

      $("pCustomer").innerHTML =
        `<b>Müşteri Bilgileri</b>\n` +
        `Firma: ${esc($("customerName").value || "-")}\n` +
        `Tel: ${esc($("customerPhone").value || "-")}\n` +
        `Mail: ${esc($("customerEmail").value || "-")}\n` +
        `Adres: ${esc($("customerAddress").value || "-")}`.replaceAll("\n","<br>");

      $("pQuote").innerHTML =
        `<b>Teklif</b>\n` +
        `Teklif No: ${esc($("quoteNo").value || "-")}\n` +
        `Tarih: ${esc($("quoteDate").value || "-")}`.replaceAll("\n","<br>");

      $("pNote").textContent = $("quoteNote").value?.trim() ? $("quoteNote").value.trim() : "-";

      // logo + kaşe
      $("pLogo").innerHTML  = `<img src="${CONFIG.logoPath}" alt="Logo">`;
      $("pStamp").innerHTML = `<img src="${CONFIG.stampPath}" alt="Kaşe">`;

      // PDF tablo: SADECE SATIŞ
      const mode = $("pdfPriceMode").value; // BOTH/INCL/EXCL
      const showExcl = (mode === "BOTH" || mode === "EXCL");
      const showIncl = (mode === "BOTH" || mode === "INCL");

      $("pThUnitExcl").style.display = showExcl ? "" : "none";
      $("pThLineExcl").style.display = showExcl ? "" : "none";
      $("pThUnitIncl").style.display = showIncl ? "" : "none";
      $("pThLineIncl").style.display = showIncl ? "" : "none";

      const body = $("pItems");
      body.innerHTML = "";

      const rows = Array.from($("itemsBody").querySelectorAll("tr"));
      for(const tr of rows){
        const name = tr.querySelector('[data-k="name"]').value.trim();
        if(!name) continue;

        const unitExcl = tr.querySelector('[data-out="saleUnitExcl"]').textContent;
        const unitIncl = tr.querySelector('[data-out="saleUnitIncl"]').textContent;
        const qty = tr.querySelector('[data-k="qty"]').value || "0";
        const lineExcl = tr.querySelector('[data-out="lineExcl"]').textContent;
        const lineIncl = tr.querySelector('[data-out="lineIncl"]').textContent;

        const r = document.createElement("tr");
        r.innerHTML = `
          <td>${esc(name)}</td>
          <td class="num" style="display:${showExcl?"":"none"};">${esc(unitExcl)}</td>
          <td class="num" style="display:${showIncl?"":"none"};">${esc(unitIncl)}</td>
          <td class="num">${esc(qty)}</td>
          <td class="num" style="display:${showExcl?"":"none"};">${esc(lineExcl)}</td>
          <td class="num" style="display:${showIncl?"":"none"};">${esc(lineIncl)}</td>
        `;
        body.appendChild(r);
      }
    }

  function printPdf(){
  recalc();
  buildPdfData();

  document.body.classList.add("printing");

  // Bazı tarayıcılarda bir frame beklemek daha temiz
  requestAnimationFrame(() => {
    setTimeout(() => window.print(), 50);
  });
}


    // Print bittikten sonra normale dön
    window.addEventListener("afterprint", ()=> {
      document.body.classList.remove("printing");
    });

    // Save/Load
    const KEY="cevizart_quote_v2";
    function collect(){
      const rows = Array.from($("itemsBody").querySelectorAll("tr")).map(tr => ({
        name: tr.querySelector('[data-k="name"]').value,
        buyExcl: tr.querySelector('[data-k="buyExcl"]').value,
        buyVat: tr.querySelector('[data-k="buyVat"]').value,
        margin: tr.querySelector('[data-k="margin"]').value,
        saleVat: tr.querySelector('[data-k="saleVat"]').value,
        qty: tr.querySelector('[data-k="qty"]').value,
      }));
      return {
        meta:{
          quoteNo:$("quoteNo").value,
          quoteDate:$("quoteDate").value,
          customerName:$("customerName").value,
          customerPhone:$("customerPhone").value,
          customerEmail:$("customerEmail").value,
          customerAddress:$("customerAddress").value,
          quoteNote:$("quoteNote").value,
          defaultMargin:$("defaultMargin").value,
          defaultSaleVat:$("defaultSaleVat").value,
          currency:$("currency").value,
          pdfPriceMode:$("pdfPriceMode").value,
        },
        rows
      };
    }
    function apply(data){
      const m=data?.meta||{};
      $("quoteNo").value = m.quoteNo||"";
      $("quoteDate").value = m.quoteDate||todayISO();
      $("customerName").value = m.customerName||"";
      $("customerPhone").value = m.customerPhone||"";
      $("customerEmail").value = m.customerEmail||"";
      $("customerAddress").value = m.customerAddress||"";
      $("quoteNote").value = m.quoteNote||"";
      $("defaultMargin").value = m.defaultMargin ?? "60";
      $("defaultSaleVat").value = m.defaultSaleVat ?? "20";
      $("currency").value = m.currency ?? "TRY";
      $("pdfPriceMode").value = m.pdfPriceMode ?? "BOTH";

      $("itemsBody").innerHTML="";
      (data?.rows||[]).forEach(r => $("itemsBody").appendChild(makeRow(r)));
      if(($("itemsBody").children.length||0)===0) $("itemsBody").appendChild(makeRow());
      recalc();
    }
    function save(){ localStorage.setItem(KEY, JSON.stringify(collect())); }
    function load(){
      const raw=localStorage.getItem(KEY);
      if(!raw) return;
      try{ apply(JSON.parse(raw)); }catch(e){}
    }
    function resetAll(){
      localStorage.removeItem(KEY);
      $("quoteNo").value="";
      $("quoteDate").value=todayISO();
      $("customerName").value="";
      $("customerPhone").value="";
      $("customerEmail").value="";
      $("customerAddress").value="";
      $("quoteNote").value="";
      $("defaultMargin").value="60";
      $("defaultSaleVat").value="20";
      $("currency").value="TRY";
      $("pdfPriceMode").value="BOTH";
      $("itemsBody").innerHTML="";
      $("itemsBody").appendChild(makeRow());
      recalc();
    }

    // init
    (function init(){
      $("quoteDate").value = todayISO();
      $("itemsBody").appendChild(makeRow());
      load();
      recalc();

      $("btnAdd").addEventListener("click", ()=>{ $("itemsBody").appendChild(makeRow()); recalc(); });
      $("btnPdf").addEventListener("click", printPdf);
      $("btnSave").addEventListener("click", save);
      $("btnLoad").addEventListener("click", load);
      $("btnReset").addEventListener("click", resetAll);

      ["defaultMargin","defaultSaleVat","currency","pdfPriceMode"].forEach(id => $(id).addEventListener("input", recalc));
    })();
  </script>
</body>
</html>
